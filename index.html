const express = require('express');
const Razorpay = require('razorpay');
const bodyParser = require('body-parser');
const session = require('express-session');

const app = express();
app.use(bodyParser.json());
app.use(express.static('public'));
app.use(session({ secret: 'flipkart-clone', resave: false, saveUninitialized: true }));

// Razorpay setup (replace with your test keys)
const razorpay = new Razorpay({
  key_id: 'rzp_test_your_key_here', // From Razorpay dashboard
  key_secret: 'your_secret_here'
});

// Sample data (in-memory; use DB for production)
let products = [
  { id: 1, name: 'iPhone 14', price: 79999, category: 'Electronics', image: 'images/product1.jpg', description: 'Latest iPhone with advanced features.' },
  { id: 2, name: 'Samsung 55" TV', price: 49999, category: 'Electronics', image: 'images/product2.jpg', description: '4K UHD Smart TV.' },
  { id: 3, name: 'Nike Air Max', price: 5999, category: 'Fashion', image: 'images/product3.jpg', description: 'Comfortable running shoes.' }
];
let users = [];
let carts = {};
let orders = {}; // User orders

// Embedded HTML/CSS/JS for pages
const indexHTML = `
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Flipkart - Online Shopping Site</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <style>
    body { font-family: 'Roboto', sans-serif; }
    .logo { width: auto; }
    .category-link { cursor: pointer; color: #2874f0; font-weight: 500; }
    .category-link:hover { color: #fb641b; }
    .product-card { border: none; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 20px; }
    .product-card img { height: 200px; object-fit: cover; }
    .product-card .card-body { padding: 15px; }
    .btn-warning { background-color: #fb641b; border-color: #fb641b; }
    .btn-warning:hover { background-color: #e55a1b; }
    .btn-primary { background-color: #2874f0; border-color: #2874f0; }
    .btn-primary:hover { background-color: #1e5bb8; }
  </style>
</head>
<body>
  <header class="bg-white border-bottom">
    <div class="container d-flex align-items-center py-2">
      <img src="images/flipkart-logo.png" alt="Flipkart" class="logo mr-4" style="height: 40px;">
      <form class="flex-grow-1 d-flex" id="searchForm">
        <input class="form-control" type="search" placeholder="Search for products, brands and more" id="searchInput">
        <button class="btn btn-warning ml-2" type="submit"><i class="fas fa-search"></i></button>
      </form>
      <div class="ml-4">
        <a href="#" class="text-dark mr-3" id="loginBtn">Login</a>
        <a href="#" class="text-dark mr-3" id="cartBtn">Cart</a>
        <a href="#" class="text-dark" id="ordersBtn">My Orders</a>
      </div>
    </div>
  </header>

  <nav class="bg-light py-2">
    <div class="container">
      <div class="row">
        <div class="col-md-2 category-link" data-category="Electronics">Electronics</div>
        <div class="col-md-2 category-link" data-category="Fashion">Fashion</div>
        <div class="col-md-2 category-link" data-category="">Home</div>
      </div>
    </div>
  </nav>

  <main class="container my-4">
    <div id="banners" class="carousel slide mb-4" data-ride="carousel">
      <div class="carousel-inner">
        <div class="carousel-item active">
          <img src="images/banner.jpg" class="d-block w-100" alt="Deals Banner" style="height: 300px; object-fit: cover;">
        </div>
      </div>
    </div>

    <h4>Featured Products</h4>
    <div class="row" id="products"></div>
  </main>

  <footer class="bg-dark text-white py-4 mt-5">
    <div class="container text-center">
      <p>&copy; 2023 Flipkart Clone. All rights reserved.</p>
    </div>
  </footer>

  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
  <script src="https://kit.fontawesome.com/a076d05399.js"></script>
  <script>
    $(document).ready(function() {
      loadProducts();

      $('#searchForm').submit(function(e) {
        e.preventDefault();
        const query = $('#searchInput').val();
        loadProducts(query);
      });

      $('.category-link').click(function() {
        const category = $(this).data('category');
        loadProducts('', category);
      });

      $('#loginBtn').click(function() {
        const username = prompt('Username:');
        const password = prompt('Password:');
        $.post('/api/login', { username, password }, function(data) {
          if (data.success) location.reload();
          else alert(data.error);
        });
      });

      $('#cartBtn').click(function() {
        window.location.href = '/cart';
      });

      $('#ordersBtn').click(function() {
        window.location.href = '/orders';
      });
    });

    function loadProducts(search = '', category = '') {
      $.get('/api/products', { search, category }, function(products) {
        $('#products').empty();
        products.forEach(p => {
          $('#products').append(\`
            <div class="col-md-3">
              <div class="card product-card">
                <img src="\${p.image}" class="card-img-top" alt="\${p.name}">
                <div class="card-body">
                  <h6>\${p.name}</h6>
                  <p class="text-success">₹\${p.price}</p>
                  <a href="/product?id=\${p.id}" class="btn btn-primary btn-sm">View Product</a>
                </div>
              </div>
            </div>
          \`);
        });
      });
    }
  </script>
</body>
</html>
`;

const productHTML = `
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Product Details - Flipkart Clone</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <style>
    body { font-family: 'Roboto', sans-serif; }
    .logo { width: auto; }
    .btn-warning { background-color: #fb641b; border-color: #fb641b; }
    .btn-warning:hover { background-color: #e55a1b; }
    .btn-primary { background-color: #2874f0; border-color: #2874f0; }
    .btn-primary:hover { background-color: #1e5bb8; }
  </style>
</head>
<body>
  <header class="bg-white border-bottom">
    <div class="container d-flex align-items-center py-2">
      <img src="images/flipkart-logo.png" alt="Flipkart" class="logo mr-4" style="height: 40px;">
      <form class="flex-grow-1 d-flex" id="searchForm">
        <input class="form-control" type="search" placeholder="Search" id="searchInput">
        <button class="btn btn-warning ml-2" type="submit"><i class="fas fa-search"></i></button>
      </form>
      <a href="/cart" class="text-dark ml-4">Cart</a>
    </div>
  </header>

  <div class="container my-4" id="productDetails"></div>

  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const id = urlParams.get('id');
    $.get(\`/api/product/\${id}\`, function(product) {
      $('#productDetails').html(\`
        <div class="row">
          <div class="col-md-6">
            <img src="\${product.image}" class="img-fluid" alt="\${product.name}">
          </div>
          <div class="col-md-6">
            <h2>\${product.name}</h2>
            <p class="text-success h4">₹\${product.price}</p>
            <p>\${product.description}</p>
            <button class="btn btn-warning btn-lg" id="addToCartBtn">Add to Cart</button>
            <button class="btn btn-primary btn-lg ml-2" id="buyNowBtn">Buy Now</button>
          </div>
        </div>
      \`);
      $('#addToCartBtn').click(function() {
        $.post('/api/cart/add', { productId: product.id }, function(data) {
          alert('Added to cart!');
        });
      });
      $('#buyNowBtn').click(function() {
        window.location.href = '/cart';
      });
    });
  </script>
</body>
</html>
`;

const cartHTML = `
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Cart - Flipkart Clone</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <style>
    body { font-family: 'Roboto', sans-serif; }
    .logo { width: auto; }
    .btn-warning { background-color: #fb641b; border-color: #fb641b; }
    .btn-warning:hover { background-color: #e55a1b; }
  </style>
</head>
<body>
  <header class="bg-white border-bottom">
    <div class="container d-flex align-items-center py-2">
      <img src="images/flipkart-logo.png" alt="Flipkart" class="logo mr-4" style="height: 40px;">
      <a href="/" class="text-dark">Home</a>
    </div>
  </header>

  <div class="container my-4">
    <h3>Your Cart</h3>
    <div id="cartItems"></div>
    <div class="text-right">
      <h4 id="totalPrice">Total: ₹0</h4>
      <button class="btn btn-warning btn-lg" id="checkoutBtn">Place Order</button>
    </div>
  </div>

  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
  <script>
    let cart = [];
    $(document).ready(function() {
      loadCart();
    });

    function loadCart() {
      $.get('/api/cart', function(data) {
        cart = data;
        $('#cartItems').empty();
        let total = 0;
        cart.forEach((item, index) => {
          total += item.price;
          $('#cartItems').append(\`
            <div class="d-flex justify-content-between align-items-center border-bottom py-2">
              <img src="\${item.image}" style="width: 50px; height: 50px; object-fit: cover;" alt="\${item.name}">
              <span>\${item.name} - ₹\${item.price}</span>
              <button class="btn btn-danger btn-sm" onclick="removeItem(\${index})">Remove</button>
            </div>
          \`);
        });
        $('#totalPrice').text(\`Total: ₹\${total}\`);
      });
    }

    function removeItem(index) {
      $.ajax({ url: \`/api/cart/remove/\${index}\`, type: 'DELETE', success: loadCart });
    }

    $('#checkoutBtn').click(function() {
      $.post('/api/create-order', {}, function(data) {
        const options = {
          key: 'rzp_test_your_key_here', // Same as backend
          amount: data.amount,
          currency: 'INR',
          order_id: data.orderId,
          name: 'Flipkart Clone',
          description: 'Purchase',
          handler: function(response) {
            $.post('/api/confirm-order', { paymentId: response.razorpay_payment_id, orderId: data.orderId }, function() {
              window.location.href = '/order-success?orderId=' + data.orderId;
            });
          },
          prefill: { method: 'upi' } // Forces UPI
        };
        const rzp = new Razorpay(options);
        rzp.open();
      });
    });
  </script>
</body>
</html>
`;

const orderSuccessHTML = `
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Order Success - Flipkart Clone</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
</head>
<body>
  <div class="container my-4 text-center">
    <h2 class="text-success">Order Placed Successfully!</h2>
    <p>Your order ID is: <strong id="orderId"></strong></p>
    <a href="/" class="btn btn-primary">Continue Shopping</a>
  </div>
  <script>
    const urlParams = new URLSearchParams(window.location.search);
    document.getElementById('orderId').textContent = urlParams.get('orderId');
  </script>
</body>
</html>
`;

const ordersHTML = `
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>My Orders - Flipkart Clone</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
</head>
<body>
  <div class="container my-4">
    <h3>My Orders</h3>
    <div id="ordersList"></div>
  </div>
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script>
    $(document).ready(function() {
      $.get('/api/orders', function(orders) {
        orders.forEach(order => {
          $('#ordersList').append(\`<p>Order ID: \${order.id} - Date: \${order.date} - Items: \${order.items.map(i => i.name).join(', ')}</p>\`);
        });
      });
    });
  </script>
</body>
</html>
`;

// Routes
app.get('/', (req, res) => res.send(indexHTML));
app.get('/product', (req, res) => res.send(productHTML));
app.get('/cart', (req, res) => res.send(cartHTML));
app.get('/order-success', (req, res) => res.send(orderSuccessHTML));
app.get('/orders', (req, res) => res.send(ordersHTML));

app.get('/api/products', (req, res) => {
  const { search, category } = req.query;
  let filtered = products;
  if (search) filtered = filtered.filter(p => p.name.toLowerCase().includes(search.toLowerCase()));
  if (category) filtered = filtered.filter(p => p.category === category);
  res.json(filtered);
});

app.get('/api/product/:id', (req, res) => {
  const product = products.find(p => p.id == req.params.id);
  res.json(product);
});

app.post('/api/signup', (req, res) => {
  const { username, password } = req.body;
  if (users.find(u => u.username === username)) return res.status(400).json({ error: 'User exists' });
  users.push({ username, password });
  req.session.user = username;
  carts[username] = [];
  orders[username] = [];
  res.json({ success: true });
});

app.post('/api/login', (req, res) => {
  const { username, password } = req.body;
  const user = users.find(u => u.username === username && u.password === password);
  if (!user) return res.status(400).json({ error: 'Invalid credentials' });
  req.session.user = username;
  carts[username] = carts[username] || [];
  orders[username] = orders[username] || [];
  res.json({ success: true });
});

app.post('/api/cart/add', (req, res) => {
  if (!req.session.user) return res.status(401).json({ error: 'Login required' });
  const { productId } = req.body;
  const product = products.find(p => p.id == productId);
  carts[req.session.user].push(product);
  res.json({ success: true });
});

app.get('/api/cart', (req, res) => {
  if (!req.session.user) return res.status(401).json({ error: 'Login required' });
  res.json(carts[req.session.user]);
});

app.delete('/api/cart/remove/:index', (req, res) => {
  if (!req.session.user) return res.status(401).json({ error: 'Login required' });
  carts[req.session.user].splice(req.params.index, 1);
  res.json({ success: true });
});

app.post('/api/create-order', async (req, res) => {
  if (!req.session.user) return res.status(401).json({ error: 'Login required' });
  const cart = carts[req.session.user];
  if (cart.length === 0) return res.status(400).json({ error: 'Cart is empty' });
  const amount = cart.reduce((sum, p) => sum + p.price, 0) * 100; // Paise
  const options = {
    amount,
    currency: 'INR',
    receipt: \`order_\${Date.now()}\`
  };
  const order = await razorpay.orders.create(options);
  res.json({ orderId: order.id, amount, cart });
});

app.post('/api/confirm-order', (req, res) => {
  if (!req.session.user)
